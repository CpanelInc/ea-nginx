server {
    server_name[% FOREACH domain IN domains %] [% domain %] www.[% domain %][% END %];
    listen 80;

    [%- IF ssl_certificate && ssl_certificate_key %]
    listen 443 ssl;
    ssl_certificate [% ssl_certificate %];
    ssl_certificate_key [% ssl_certificate_key %];
    [% END -%]

    root [% docroot %];
    index [% IF fpm_socket %]index.php [% END %]index.html;

    [%- IF fpm_socket %]
    location ~ \.php[% fpm_socket_php_major_version ? fpm_socket_php_major_version _ "?" : "" %]$ {
        include conf.d/includes-optional/cpanel-fastcgi.conf;
        fastcgi_pass unix:[% fpm_socket %];
    }
    [%- END %]

    include conf.d/server-includes/*.conf;
    include conf.d/users/[% user %]/*.conf;
    include conf.d/users/[% user %]/[% domains.0 %]/*.conf;
}

[%- IF ssl_certificate && ssl_certificate_key %]
    [%- FOREACH domain IN domains %]
#### SSL Proxies for [% domain %] ##
    [%- SET subdom_map = {
            cpanel  = 2082, webmail    = 2095, whm        = 2086,
            webdisk = 2077, cpcontacts = 2079, cpcalendars = 2079,
        }
    -%]
        [%- FOREACH proxy_subdomain IN subdom_map.keys.sort %]
server {
    listen 443 ssl;
    ssl_certificate [% ssl_certificate %];
    ssl_certificate_key [% ssl_certificate_key %];

    server_name [% FOREACH domain IN domains %] [% proxy_subdomain %].[% domain %][% END %];

    location / {
        [%- IF proxy_subdomain.match('^(?:cpanel|webmail|whm)$') %]
        # since proxy_set_header can not be done inside an if block we jump though hoops
        # default value is empty because the header will be only sent if $value is not empty
        set $upgrade_value "";
        set $connection_value "";

        if ($http_upgrade ~* ^websocket$) {
            set $upgrade_value $http_upgrade;
            set $connection_value "upgrade";
        }

        # In nginx you still need to use `http` for protocol in your url and not `ws`.
        # The `ws` and `wss` protocol are required for browser, in the nginx side we add
        #   the headers below to handle the websockets over `http`.
        proxy_set_header Upgrade $upgrade_value; # the header will be only sent if $upgrade_value is not empty
        proxy_set_header Connection $connection_value; # the header will be only sent if $connection_value is not empty
        [%- END %]
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_pass http://127.0.0.1:[% subdom_map.$proxy_subdomain %];
    }
}

        [%- END -%]
    [%- END -%]
[%- END -%]
